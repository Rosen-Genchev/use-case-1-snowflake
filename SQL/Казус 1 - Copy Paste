CREATE DATABASE SPIDER_ECOMERSE_DB;

CREATE OR REPLACE SCHEMA STAGE_EXTERNAL;

--създаване на всички таблици необходими за заданията

CREATE OR REPLACE TABLE SPIDER_ECOMERSE_DB.STAGE_EXTERNAL.RAW_ORDERS (
    ORDER_ID NUMBER(38,0),
    CUSTOMER_ID VARCHAR(16777216),
    CUSTOMER_NAME VARCHAR(16777216),
    ORDER_DATE VARCHAR(16777216),
    PRODUCT VARCHAR(16777216),
    QUANTITY NUMBER(38,0),
    PRICE NUMBER(38,0),
    DISCOUNT NUMBER(38,2),
    TOTAL_AMOUNT NUMBER(38,2),
    PAYMENT_METHOD VARCHAR(16777216),
    SHIPPING_ADDRESS VARCHAR(16777216),
    STATUS VARCHAR(16777216)
);

CREATE OR REPLACE TABLE TD_FOR_REVIEW (
    ORDER_ID NUMBER(38,0),
    CUSTOMER_ID VARCHAR(16777216),
    CUSTOMER_NAME VARCHAR(16777216),
    ORDER_DATE VARCHAR(16777216),
    PRODUCT VARCHAR(16777216),
    QUANTITY NUMBER(38,0),
    PRICE NUMBER(38,0),
    DISCOUNT NUMBER(38,2),
    TOTAL_AMOUNT NUMBER(38,2),
    PAYMENT_METHOD VARCHAR(16777216),
    SHIPPING_ADDRESS VARCHAR(16777216),
    STATUS VARCHAR(16777216)
);

CREATE OR REPLACE TABLE TD_SUSPISIOS_RECORDS (
    ORDER_ID NUMBER(38,0),
    CUSTOMER_ID VARCHAR(16777216),
    CUSTOMER_NAME VARCHAR(16777216),
    ORDER_DATE VARCHAR(16777216),
    PRODUCT VARCHAR(16777216),
    QUANTITY NUMBER(38,0),
    PRICE NUMBER(38,0),
    DISCOUNT NUMBER(38,2),
    TOTAL_AMOUNT NUMBER(38,2),
    PAYMENT_METHOD VARCHAR(16777216),
    SHIPPING_ADDRESS VARCHAR(16777216),
    STATUS VARCHAR(16777216)
);

CREATE OR REPLACE TABLE TD_INVALID_DATE_FORMAT (
    ORDER_ID NUMBER(38,0),
    CUSTOMER_ID VARCHAR(16777216),
    CUSTOMER_NAME VARCHAR(16777216),
    ORDER_DATE VARCHAR(16777216),
    PRODUCT VARCHAR(16777216),
    QUANTITY NUMBER(38,0),
    PRICE NUMBER(38,0),
    DISCOUNT NUMBER(38,2),
    TOTAL_AMOUNT NUMBER(38,2),
    PAYMENT_METHOD VARCHAR(16777216),
    SHIPPING_ADDRESS VARCHAR(16777216),
    STATUS VARCHAR(16777216)
);

CREATE OR REPLACE TABLE TD_INVALID_VALUES (
    ORDER_ID NUMBER(38,0),
    CUSTOMER_ID VARCHAR(16777216),
    CUSTOMER_NAME VARCHAR(16777216),
    ORDER_DATE VARCHAR(16777216),
    PRODUCT VARCHAR(16777216),
    QUANTITY NUMBER(38,0),
    PRICE NUMBER(38,0),
    DISCOUNT NUMBER(38,2),
    TOTAL_AMOUNT NUMBER(38,2),
    PAYMENT_METHOD VARCHAR(16777216),
    SHIPPING_ADDRESS VARCHAR(16777216),
    STATUS VARCHAR(16777216)
);

CREATE OR REPLACE TABLE TD_CLEAN_RECORDS (
    ORDER_ID NUMBER(38,0),
    CUSTOMER_ID VARCHAR(16777216),
    CUSTOMER_NAME VARCHAR(16777216),
    ORDER_DATE VARCHAR(16777216),
    PRODUCT VARCHAR(16777216),
    QUANTITY NUMBER(38,0),
    PRICE NUMBER(38,0),
    DISCOUNT NUMBER(38,2),
    TOTAL_AMOUNT NUMBER(38,2),
    PAYMENT_METHOD VARCHAR(16777216),
    SHIPPING_ADDRESS VARCHAR(16777216),
    STATUS VARCHAR(16777216)
);
--Коригиране на липсващи данни
INSERT INTO TD_FOR_REVIEW (
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
)
SELECT
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
FROM RAW_ORDERS
WHERE SHIPPING_ADDRESS IS NULL AND STATUS = 'DELIVERED';

INSERT INTO TD_SUSPISIOS_RECORDS (
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
)
SELECT
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
FROM RAW_ORDERS
WHERE CUSTOMER_NAME IS NULL;

UPDATE RAW_ORDERS
SET PAYMENT_METHOD = 'UNKNOWN'
WHERE PAYMENT_METHOD IS NULL;

SELECT ORDER_DATE
FROM RAW_ORDERS
WHERE TRY_TO_DATE(ORDER_DATE, 'YYYY-MM-DD') IS NULL;
--Невалиден формат на данните
INSERT INTO TD_INVALID_DATE_FORMAT (
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
)
SELECT
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
FROM RAW_ORDERS
WHERE TRY_TO_DATE(ORDER_DATE, 'YYYY-MM-DD') IS NULL;

UPDATE RAW_ORDERS
SET ORDER_DATE = CASE 
    WHEN SUBSTR(ORDER_DATE, 6, 2) = '02' 
         AND TRY_TO_DATE(ORDER_DATE, 'YYYY-MM-DD') IS NULL 
    THEN SUBSTR(ORDER_DATE, 1, 5) || '02-28'
    ELSE ORDER_DATE
END
WHERE SUBSTR(ORDER_DATE, 6, 2) = '02'
  AND TRY_TO_DATE(ORDER_DATE, 'YYYY-MM-DD') IS NULL;
--Отрицателни или нулеви стойности за количество и цена
INSERT INTO TD_INVALID_VALUES (
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
)
SELECT
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
FROM RAW_ORDERS
WHERE QUANTITY <= 0 OR QUANTITY IS NULL OR PRICE <= 0 OR PRICE IS NULL;

DELETE FROM RAW_ORDERS
WHERE QUANTITY <= 0 OR QUANTITY IS NULL OR PRICE <= 0 OR PRICE IS NULL;
--Невалидна отстъпка
UPDATE RAW_ORDERS
SET DISCOUNT = 0
WHERE DISCOUNT < 0;

UPDATE RAW_ORDERS
SET DISCOUNT = 0.50
WHERE DISCOUNT > 0.50;
--Неправилно калкулирана цена
UPDATE RAW_ORDERS
SET TOTAL_AMOUNT = (PRICE * QUANTITY) - (PRICE * QUANTITY) * DISCOUNT;
--Неконсистентни статуси на поръчките
UPDATE RAW_ORDERS
SET STATUS = 'PENDING'
WHERE SHIPPING_ADDRESS IS NULL AND STATUS = 'DELIVERED';
--Дуплицирани редове
SELECT DISTINCT *
FROM RAW_ORDERS;

INSERT INTO TD_CLEAN_RECORDS (
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
)
SELECT DISTINCT
    ORDER_ID, CUSTOMER_ID, CUSTOMER_NAME, ORDER_DATE, PRODUCT,
    QUANTITY, PRICE, DISCOUNT, TOTAL_AMOUNT, PAYMENT_METHOD,
    SHIPPING_ADDRESS, STATUS
FROM RAW_ORDERS;
